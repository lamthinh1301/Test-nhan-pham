<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Vòng Quay Nhân Phẩm</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f3f3f3;
    }
    h1 {
      color: #4a148c;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    #result, #admin-panel, #leaderboard {
      margin-top: 20px;
      padding: 15px;
      background: #ffffff;
      border-radius: 8px;
      display: none;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
    }
  </style>
</head>
<body>

  <h1>🎯 Vòng Quay Nhân Phẩm 🎯</h1>

  <input type="text" id="nameInput" placeholder="Nhập tên của bạn" />
  <button onclick="play()">Quay điểm</button>

  <div id="result"></div>

  <hr>
  <div>
    <input type="password" id="adminCode" placeholder="Nhập mã admin (12344321)" />
    <button onclick="loginAdmin()">Đăng nhập Admin</button>
  </div>

  <div id="admin-panel">
    <h2>🔐 Bảng Quản Lý Admin</h2>
    <button onclick="revealAll()">📢 Công bố điểm</button>
    <button onclick="resetAll()">🔄 Reset toàn bộ</button>
    <br><br>
    <input type="text" id="resetOneName" placeholder="Tên người cần reset" />
    <button onclick="resetOne()">Reset người này</button>
  </div>

  <div id="leaderboard">
    <h2>🏆 Bảng xếp hạng</h2>
    <table id="rankTable">
      <tr><th>STT</th><th>Tên</th><th>Điểm</th></tr>
    </table>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwXY66kDQld99FREk9EaWcjk5FKUuriEi6N3X3b_u_o1Fg4MrylwDt802pn8_N3_JL2dg/exec";
    let currentUser = "";

    function play() {
      const name = document.getElementById("nameInput").value.trim();
      if (!name) return alert("Vui lòng nhập tên");
      currentUser = name;
      fetch(`${scriptURL}?action=play&name=${encodeURIComponent(name)}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "exists") {
            document.getElementById("result").innerHTML = `Bạn đã quay rồi! Điểm của bạn là: <strong>${data.score}</strong>`;
          } else {
            document.getElementById("result").innerHTML = `Bạn vừa quay được: <strong>${data.score}</strong>`;
          }
          document.getElementById("result").style.display = "block";
          loadLeaderboard(false);
        });
    }

    function loginAdmin() {
      const code = document.getElementById("adminCode").value;
      if (code === "12344321") {
        document.getElementById("admin-panel").style.display = "block";
        loadLeaderboard(true);
      } else {
        alert("Sai mã admin");
      }
    }

    function revealAll() {
      loadLeaderboard(true);
      document.getElementById("leaderboard").style.display = "block";
    }

    function resetAll() {
      if (!confirm("Bạn có chắc chắn muốn reset toàn bộ không?")) return;
      fetch(`${scriptURL}?action=resetAll`)
        .then(() => {
          alert("Đã reset toàn bộ!");
          location.reload();
        });
    }

    function resetOne() {
      const name = document.getElementById("resetOneName").value.trim();
      if (!name) return alert("Nhập tên người cần reset");
      fetch(`${scriptURL}?action=resetOne&name=${encodeURIComponent(name)}`)
        .then(res => res.text())
        .then(text => {
          if (text.includes("done")) {
            alert(`Đã reset: ${name}`);
            loadLeaderboard(true);
          } else {
            alert("Không tìm thấy người này.");
          }
        });
    }

    function loadLeaderboard(showAll) {
      fetch(`${scriptURL}?action=get`)
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("rankTable");
          table.innerHTML = "<tr><th>STT</th><th>Tên</th><th>Điểm</th></tr>";
          let sorted = data.sort((a, b) => b.score - a.score);
          sorted.forEach((row, index) => {
            let score = (showAll || row.name === currentUser) ? row.score : '***';
            const tr = `<tr><td>${index + 1}</td><td>${row.name}</td><td>${score}</td></tr>`;
            table.innerHTML += tr;
          });
          if (showAll) {
            document.getElementById("leaderboard").style.display = "block";
          }
        });
    }
  </script>

</body>
</html>
